# Production Docker Compose Configuration
# Optimized for 15GB host memory limit

name: somabrain-prod

services:
  somabrain_redis:
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru --tcp-keepalive 60 --timeout 300 --tcp-backlog 511
    environment:
      REDIS_MAXMEMORY_POLICY: allkeys-lru

  somabrain_kafka:
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1.5G
    environment:
      KAFKA_HEAP_OPTS: "-Xmx1.5g -Xms1.5g -XX:+UseG1GC -XX:MaxGCPauseMillis=20"
      KAFKA_JVM_PERFORMANCE_OPTS: "-server -XX:+UseG1GC -XX:MaxGCPauseMillis=20"
      KAFKA_CFG_DEFAULT_REPLICATION_FACTOR: 1
      KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_CFG_LOG_RETENTION_MS: 604800000
      KAFKA_CFG_LOG_RETENTION_BYTES: 1073741824

  somabrain_postgres:
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1.5G
    environment:
      POSTGRES_SHARED_BUFFERS: 512MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 1.5GB
      POSTGRES_MAX_CONNECTIONS: 100
      POSTGRES_MAINTENANCE_WORK_MEM: 128MB
      POSTGRES_CHECKPOINT_COMPLETION_TARGET: 0.9
      POSTGRES_WAL_BUFFERS: 16MB
      POSTGRES_DEFAULT_STATISTICS_TARGET: 100
      POSTGRES_RANDOM_PAGE_COST: 1.1
      POSTGRES_EFFECTIVE_IO_CONCURRENCY: 200
      POSTGRES_WORK_MEM: 2MB
      POSTGRES_MIN_WAL_SIZE: 1GB
      POSTGRES_MAX_WAL_SIZE: 4GB
      POSTGRES_LOG_STATEMENT: 'all'
      POSTGRES_LOG_MIN_DURATION_STATEMENT: 1000

  somabrain_app:
    deploy:
      resources:
        limits:
          memory: 2.5G
        reservations:
          memory: 2G
    environment:
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
      WORKERS: 4
      WORKER_TIMEOUT: 300
      WORKER_MAX_REQUESTS: 1000
      WORKER_MAX_REQUESTS_JITTER: 50

  somabrain_cog:
    deploy:
      resources:
        limits:
          memory: 3.5G
        reservations:
          memory: 3G
    environment:
      JAVA_TOOL_OPTIONS: "-Xmx3g -Xms3g -XX:+UseG1GC -XX:MaxGCPauseMillis=20"
      WORKER_PROCESSES: 4

  somabrain_opa:
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  somabrain_outbox_publisher:
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  somabrain_prometheus:
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    command: |
      --config.file=/etc/prometheus/prometheus.yml
      --storage.tsdb.path=/prometheus
      --storage.tsdb.retention.time=30d
      --storage.tsdb.retention.size=2GB
      --web.console.libraries=/etc/prometheus/console_libraries
      --web.console.templates=/etc/prometheus/consoles
      --web.enable-lifecycle

  somabrain_jaeger:
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  somabrain_test:
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

# Memory usage summary: 12.7GB total (within 15GB limit)
# Includes 2.3GB buffer for OS and container overhead