groups:
  - name: somabrain_alerts
    rules:
      - alert: HighAvgRequestLatency
        expr: (rate(somabrain_http_latency_seconds_sum[5m]) / rate(somabrain_http_latency_seconds_count[5m])) * 1000 > 500
        for: 3m
        labels:
          severity: page
        annotations:
          summary: "High average request latency"
          description: "Average request latency > 500 ms for 3m"

      - alert: WMUtilizationHigh
        expr: somabrain_wm_utilization > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Working memory utilization high"
          description: "WM utilization exceeds 85% for 5 minutes"

      # Journal fallback removed: drop journal vs admits alert

      - alert: QuotaDenies
        expr: sum(rate(somabrain_quota_denied_total[1m])) > 0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Quota denies detected"
          description: "Quota denied requests occurring"

      - alert: SupervisorAdjustmentSpike
        expr: increase(somabrain_controller_changes_total[10m]) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Parameter supervisor adjusting frequently"
          description: "Controller changes for {{ $labels.parameter }} exceeded 3 adjustments in 10m (value: {{ $value }}). Investigate metric drift."

      - alert: AnnRebuildDurationHigh
        expr: (sum by (tenant, namespace) (increase(somabrain_ann_rebuild_seconds_sum[15m])) / clamp_min(sum by (tenant, namespace) (increase(somabrain_ann_rebuild_seconds_count[15m])), 1)) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ANN rebuild duration high"
          description: "Average ANN rebuild time for tenant {{ $labels.tenant }} namespace {{ $labels.namespace }} exceeded 2s over 15m (value: {{ $value }}s)."

      - alert: AnnRebuildBurst
        expr: sum by (tenant, namespace, backend) (increase(somabrain_ann_rebuild_total[10m])) > 5
        for: 5m
        labels:
          severity: info
        annotations:
          summary: "ANN rebuilds occurring frequently"
          description: "ANN rebuild count for tenant {{ $labels.tenant }} namespace {{ $labels.namespace }} backend {{ $labels.backend }} exceeded 5 in 10m (value: {{ $value }}). Review rebuild scheduling."

      # API 5xx error rate per-tenant > 5% over 10m
      - alert: SomabrainErrorRateHigh
        expr: sum by (tenant) (rate(somabrain_http_requests_total{status=~"5.."}[5m]))
              /
              sum by (tenant) (rate(somabrain_http_requests_total[5m])) > 0.05
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High 5xx error rate for tenant {{ $labels.tenant }}"
          description: "5xx rate > 5% over 10m for tenant {{ $labels.tenant }}"

      # Integrator global frames absent
      - alert: CogGlobalFrameAbsent
        expr: sum(rate(somabrain_integrator_frames_total[5m])) == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "No GlobalFrame messages observed"
          description: "cog.global.frame has no publishes for 5 minutes."

      # Consistency kappa sustained low (requires integrator metric somabrain_kappa)
      - alert: ConsistencyKappaLow
        expr: avg_over_time(somabrain_kappa[10m]) < 0.2
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Consistency kappa low"
          description: "Average Îº below 0.2 over 10m (value: {{ $value }}). Investigate predictor alignment and fusion weights."

      # OPA veto ratio sustained above 10%
      - alert: OpaVetoRatioElevated
        expr: somabrain_integrator_opa_veto_ratio > 0.10
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "OPA veto ratio elevated"
          description: "OPA denies exceed 10% of decisions over 10m (value: {{ $value }}). Review policy or input drift."

      # Planning latency p99 above 40ms
      - alert: PlanningLatencyP99High
        expr: somabrain_planning_latency_p99 > 0.040
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Planning p99 latency high"
          description: "Planning latency p99 above 40ms for 10m (value: {{ $value }}s). Investigate graph or retrieval pressure."

      # Regret EWMA above 0.08 indicates degraded policy feedback quality
      - alert: LearningRegretEwmaHigh
        expr: somabrain_learning_regret_ewma > 0.08
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Learning regret EWMA high"
          description: "EWMA regret above 0.08 for 15m (value: {{ $value }}). Consider rollback or parameter tuning."

      # Drift detection alerts from service counters
      - alert: DriftEventsBurst
        expr: increase(somabrain_drift_events_total[10m]) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Drift events increasing"
          description: "Drift events exceeded 3 in 10m for {{ $labels.domain }} {{ $labels.tenant }} (value: {{ $value }})."

      # HMM segmentation volatility sustained high
      - alert: SegmentationVolatileHigh
        expr: avg by (tenant, domain) (rate(somabrain_seg_p_volatile_bucket[5m])) > 0.6
        for: 10m
        labels:
          severity: info
        annotations:
          summary: "High VOLATILE state probability"
          description: "Posterior VOLATILE probability sustained high for {{ $labels.tenant }} {{ $labels.domain }}."

      # Kafka consumer lag (requires kafka_exporter)
      - alert: KafkaConsumerLagHigh
        expr: max by (consumergroup) (kafka_consumergroup_lag) > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kafka consumer lag high"
          description: "One or more consumer groups have lag above 1000."

      - alert: KafkaConsumerLagCritical
        expr: max by (consumergroup) (kafka_consumergroup_lag) > 5000
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Kafka consumer lag critical"
          description: "One or more consumer groups have lag above 5000."
