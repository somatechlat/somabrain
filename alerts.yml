groups:
  - name: somabrain_alerts
    rules:
      - alert: HighAvgRequestLatency
        expr: (rate(somabrain_http_latency_seconds_sum[5m]) / rate(somabrain_http_latency_seconds_count[5m])) * 1000 > 500
        for: 3m
        labels:
          severity: page
        annotations:
          summary: "High average request latency"
          description: "Average request latency > 500 ms for 3m"

      - alert: WMUtilizationHigh
        expr: somabrain_wm_utilization > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Working memory utilization high"
          description: "WM utilization exceeds 85% for 5 minutes"

      - alert: JournalVsAdmits
        expr: (sum(rate(somabrain_journal_append_total[1m])) == 0) and (sum(rate(somabrain_wm_admit_total[1m])) > 10)
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Journal appends stopped while WM admits high"
          description: "No journal appends but WM admits > 10/min for 2 minutes"

      - alert: QuotaDenies
        expr: sum(rate(somabrain_quota_denied_total[1m])) > 0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Quota denies detected"
          description: "Quota denied requests occurring"

      - alert: SupervisorAdjustmentSpike
        expr: increase(somabrain_controller_changes_total[10m]) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Parameter supervisor adjusting frequently"
          description: "Controller changes for {{ $labels.parameter }} exceeded 3 adjustments in 10m (value: {{ $value }}). Investigate metric drift."

      - alert: AnnRebuildDurationHigh
        expr: (sum by (tenant, namespace) (increase(somabrain_ann_rebuild_seconds_sum[15m])) / clamp_min(sum by (tenant, namespace) (increase(somabrain_ann_rebuild_seconds_count[15m])), 1)) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ANN rebuild duration high"
          description: "Average ANN rebuild time for tenant {{ $labels.tenant }} namespace {{ $labels.namespace }} exceeded 2s over 15m (value: {{ $value }}s)."

      - alert: AnnRebuildBurst
        expr: sum by (tenant, namespace, backend) (increase(somabrain_ann_rebuild_total[10m])) > 5
        for: 5m
        labels:
          severity: info
        annotations:
          summary: "ANN rebuilds occurring frequently"
          description: "ANN rebuild count for tenant {{ $labels.tenant }} namespace {{ $labels.namespace }} backend {{ $labels.backend }} exceeded 5 in 10m (value: {{ $value }}). Review rebuild scheduling."

      # API 5xx error rate per-tenant > 5% over 10m
      - alert: SomabrainErrorRateHigh
        expr: sum by (tenant) (rate(somabrain_http_requests_total{status=~"5.."}[5m]))
              /
              sum by (tenant) (rate(somabrain_http_requests_total[5m])) > 0.05
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High 5xx error rate for tenant {{ $labels.tenant }}"
          description: "5xx rate > 5% over 10m for tenant {{ $labels.tenant }}"

      # Integrator global frames absent
      - alert: CogGlobalFrameAbsent
        expr: sum(rate(somabrain_integrator_frames_total[5m])) == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "No GlobalFrame messages observed"
          description: "cog.global.frame has no publishes for 5 minutes."

      # Kafka consumer lag (requires kafka_exporter)
      - alert: KafkaConsumerLagHigh
        expr: max by (consumergroup) (kafka_consumergroup_lag) > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kafka consumer lag high"
          description: "One or more consumer groups have lag above 1000."

      - alert: KafkaConsumerLagCritical
        expr: max by (consumergroup) (kafka_consumergroup_lag) > 5000
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Kafka consumer lag critical"
          description: "One or more consumer groups have lag above 5000."
