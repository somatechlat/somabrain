{{- /*
Render Grafana Dashboard ConfigMaps when enabled. These are intended to be
picked up by the Grafana dashboards sidecar (as used by kube-prometheus-stack),
which watches for label grafana_dashboard: "1".
*/ -}}
{{- if and .Values.grafana .Values.grafana.dashboards .Values.grafana.dashboards.enabled }}
{{- $ns := .Values.grafana.dashboards.namespace | default .Release.Namespace }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "soma-infra.fullname" . }}-dashboard-cog-thread
  namespace: {{ $ns }}
  labels:
    grafana_dashboard: "1"
    app.kubernetes.io/name: {{ include "soma-infra.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
  annotations:
    helm.sh/resource-policy: keep
    # Optional: make upgrades idempotent for dev
    checksum/config: {{ .Values.configHash | default "" | quote }}
data:
  somabrain_autonomous.json: |
{{ .Files.Get "grafana/provisioning/dashboards/autonomous_dashboard.json" | indent 4 }}
---
{{- end }}
