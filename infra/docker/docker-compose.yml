name: somabrain

services:
  somabrain_redis:
    image: redis:7.2-alpine
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    networks:
      - somabrain_net
    ports:
      - "${REDIS_HOST_PORT:-30100}:${REDIS_CONTAINER_PORT:-6379}"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 30s
      timeout: 5s
      retries: 3
    volumes:
      - redis_data:/data
    # Production-like Redis configuration with persistence and memory management
    command:
      - redis-server
      - --maxmemory
      - "800mb"
      - --maxmemory-policy
      - "allkeys-lru"
      - --appendonly
      - "yes"
      - --appendfsync
      - "everysec"
      - --save
      - "900 1"
      - --save
      - "300 10"
      - --save
      - "60 10000"
      - --tcp-keepalive
      - "300"
      - --timeout
      - "0"
      - --tcp-backlog
      - "511"
      - --databases
      - "16"
      - --loglevel
      - "notice"

  somabrain_kafka:
    image: apache/kafka:3.7.0
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    environment:
      # Production-like Kafka configuration for constrained environment
      KAFKA_CFG_NODE_ID: ${KAFKA_CFG_NODE_ID:-1}
      KAFKA_CFG_PROCESS_ROLES: ${KAFKA_CFG_PROCESS_ROLES:-broker,controller}
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: ${KAFKA_CFG_CONTROLLER_QUORUM_VOTERS:-1@somabrain_kafka:9093}
      KAFKA_CFG_LISTENERS: ${KAFKA_CFG_LISTENERS:-INTERNAL://0.0.0.0:9092,EXTERNAL://0.0.0.0:9094,CONTROLLER://0.0.0.0:9093}
      KAFKA_CFG_ADVERTISED_LISTENERS: INTERNAL://somabrain_kafka:9092,EXTERNAL://localhost:30102
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: ${KAFKA_CFG_CONTROLLER_LISTENER_NAMES:-CONTROLLER}
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: ${KAFKA_CFG_INTER_BROKER_LISTENER_NAME:-INTERNAL}
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: ${KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP:-CONTROLLER:PLAINTEXT,INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT}
      # Production settings
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_CFG_NUM_PARTITIONS: "3"
      KAFKA_CFG_DEFAULT_REPLICATION_FACTOR: 1
      KAFKA_CFG_MIN_INSYNC_REPLICAS: 1
      KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR: 1
      # Storage and retention (production-like)
      KAFKA_CFG_LOG_DIRS: "/var/lib/kafka/data"
      KAFKA_CFG_LOG_RETENTION_MS: "604800000"
      KAFKA_CFG_LOG_RETENTION_BYTES: "1073741824"
      KAFKA_CFG_LOG_SEGMENT_BYTES: "67108864"
      KAFKA_CFG_LOG_CLEANUP_POLICY: "delete"
      KAFKA_CFG_LOG_RETENTION_CHECK_INTERVAL_MS: "300000"
      # Performance tuning
      KAFKA_CFG_COMPRESSION_TYPE: "snappy"
      KAFKA_CFG_MESSAGE_MAX_BYTES: "1048576"
      KAFKA_CFG_REPLICA_FETCH_MAX_BYTES: "1048576"
      KAFKA_CFG_NUM_IO_THREADS: "4"
      KAFKA_CFG_NUM_NETWORK_THREADS: "3"
      KAFKA_CFG_NUM_REPLICA_FETCHERS: "1"
      KAFKA_CFG_SOCKET_SEND_BUFFER_BYTES: "102400"
      KAFKA_CFG_SOCKET_RECEIVE_BUFFER_BYTES: "102400"
      KAFKA_CFG_SOCKET_REQUEST_MAX_BYTES: "104857600"
      # JVM settings for constrained memory
      KAFKA_HEAP_OPTS: "-Xmx1g -Xms512m"
      KAFKA_JVM_PERFORMANCE_OPTS: "-server -XX:+UseG1GC -XX:MaxGCPauseMillis=20 -XX:InitiatingHeapOccupancyPercent=35 -XX:+ExplicitGCInvokesConcurrent"
      KAFKA_CLUSTER_ID: ${KAFKA_CLUSTER_ID:-79LccNO-Qe6G6YgqP1Zrew}
      KAFKA_BROKER_HOST_PORT: ${KAFKA_BROKER_HOST_PORT:-30102}
      KAFKA_BROKER_CONTAINER_PORT: ${KAFKA_BROKER_CONTAINER_PORT:-9092}
    volumes:
      # Persist Kafka broker data in the correct data directory.
      # The apache/kafka image uses /var/lib/kafka/data for logs; mounting at that
      # exact path avoids Docker creating an anonymous volume that overrides persistence.
      - kafka_data:/var/lib/kafka/data
    command:
      - bash
      - -c
      - |
        set -e
        mkdir -p /var/lib/kafka/data
        CONFIG_PATH=/tmp/kafka-server.properties
        cp /opt/kafka/config/kraft/server.properties "$${CONFIG_PATH}"
        {
          echo "process.roles=$${KAFKA_CFG_PROCESS_ROLES}"
          echo "node.id=$${KAFKA_CFG_NODE_ID}"
          # Some base configs may still read broker.id; set it explicitly for safety
          echo "broker.id=$${KAFKA_CFG_NODE_ID}"
          echo "controller.listener.names=$${KAFKA_CFG_CONTROLLER_LISTENER_NAMES}"
          echo "controller.quorum.voters=$${KAFKA_CFG_CONTROLLER_QUORUM_VOTERS}"
          echo "listeners=$${KAFKA_CFG_LISTENERS}"
          echo "advertised.listeners=$${KAFKA_CFG_ADVERTISED_LISTENERS}"
          echo "listener.security.protocol.map=$${KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP}"
          echo "inter.broker.listener.name=$${KAFKA_CFG_INTER_BROKER_LISTENER_NAME}"
          echo "log.dirs=$${KAFKA_CFG_LOG_DIRS}"
          echo "auto.create.topics.enable=$${KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE}"
          echo "num.partitions=$${KAFKA_CFG_NUM_PARTITIONS}"
          echo "default.replication.factor=$${KAFKA_CFG_DEFAULT_REPLICATION_FACTOR}"
          echo "offsets.topic.replication.factor=$${KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR}"
          echo "transaction.state.log.replication.factor=$${KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR}"
          echo "transaction.state.log.min.isr=$${KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR}"
          echo "compression.type=$${KAFKA_CFG_COMPRESSION_TYPE}"
          echo "log.retention.ms=$${KAFKA_CFG_LOG_RETENTION_MS}"
          echo "log.segment.bytes=$${KAFKA_CFG_LOG_SEGMENT_BYTES}"
          echo "log.retention.bytes=$${KAFKA_CFG_LOG_RETENTION_BYTES}"
        } >> "$${CONFIG_PATH}"
        if [ ! -f /var/lib/kafka/data/meta.properties ]; then
          /opt/kafka/bin/kafka-storage.sh format --ignore-formatted --cluster-id ${KAFKA_CLUSTER_ID:-79LccNO-Qe6G6YgqP1Zrew} --config "$${CONFIG_PATH}"
        fi
        exec /opt/kafka/bin/kafka-server-start.sh "$${CONFIG_PATH}"
    ports:
      # Expose only the EXTERNAL listener container port to the host
      - "${KAFKA_BROKER_HOST_PORT:-30102}:${KAFKA_BROKER_EXTERNAL_CONTAINER_PORT:-9094}"
    healthcheck:
      test: [ "CMD-SHELL", "bash -c 'echo > /dev/tcp/::1/9092' 2>/dev/null || exit 1" ]
      interval: 10s
      timeout: 5s
      start_period: 90s
      retries: 10
    networks:
      - somabrain_net

  somabrain_kafka_exporter:
    image: danielqsj/kafka-exporter:v1.7.0
    restart: unless-stopped
    command:
      - --kafka.server=somabrain_kafka:${KAFKA_BROKER_CONTAINER_PORT:-9092}
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 32M
    depends_on:
      somabrain_kafka:
        condition: service_healthy
    ports:
      - "${KAFKA_EXPORTER_HOST_PORT:-30103}:${KAFKA_EXPORTER_CONTAINER_PORT:-9308}"
    networks:
      - somabrain_net
    healthcheck:
      test: [ "CMD", "wget", "-qO", "/dev/null", "http://localhost:9308/" ]
      interval: 30s
      timeout: 5s
      retries: 3

  somabrain_schema_registry:
    image: confluentinc/cp-schema-registry:7.6.0
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: "PLAINTEXT://somabrain_kafka:${KAFKA_BROKER_CONTAINER_PORT:-9092}"
      SCHEMA_REGISTRY_HEAP_OPTS: "-Xms128m -Xmx192m"
    depends_on:
      somabrain_kafka:
        condition: service_healthy
    networks:
      - somabrain_net
    ports:
      - "${SCHEMA_REGISTRY_HOST_PORT:-30108}:8081"
    healthcheck:
      test: [ "CMD", "wget", "-qO", "/dev/null", "http://localhost:8081/subjects" ]
      interval: 30s
      timeout: 5s
      retries: 3

  somabrain_opa:
    image: openpolicyagent/opa:0.54.0
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    # Production-like OPA configuration with decision logging and metrics
    command:
      - run
      - --server
      - --addr=0.0.0.0:8181
      - --diagnostic-addr=0.0.0.0:8282
      - --log-level=error
      - --log-format=json
      - --set=decision_logs.console=true
      - --set=status.console=true
      - --set=default_decision=somabrain/authz/allow
      - /policies
    networks:
      - somabrain_net
    ports:
      - "${OPA_HOST_PORT:-30104}:${OPA_CONTAINER_PORT:-8181}"
    volumes:
      - ./ops/opa/policies:/policies:ro
      - opa_data:/var/lib/opa
    healthcheck:
      # OPA's minimal image lacks curl/wget. Use OPA's built-in check command
      # which verifies the server is running and policies are loaded.
      test: [ "CMD", "/opa", "check", "/policies" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  somabrain_prometheus:
    image: prom/prometheus:v2.49.0
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    networks:
      - somabrain_net
    ports:
      - "${PROMETHEUS_HOST_PORT:-30105}:${PROMETHEUS_CONTAINER_PORT:-9090}"
    volumes:
      - ../../ops/prometheus/etc/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    # Production-like Prometheus configuration
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --storage.tsdb.retention.time=7d
      - --storage.tsdb.retention.size=512MB
      - --storage.tsdb.min-block-duration=2h
      - --storage.tsdb.max-block-duration=2h
      - --web.console.libraries=/usr/share/prometheus/console_libraries
      - --web.console.templates=/usr/share/prometheus/consoles
      - --web.enable-lifecycle
      - --web.enable-admin-api
      - --log.level=warn
      - --log.format=json
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:9090/-/healthy" ]
      interval: 30s
      timeout: 5s
      retries: 3

  somabrain_jaeger:
    image: jaegertracing/all-in-one:1.53
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    networks:
      - somabrain_net
    ports:
      - "${JAEGER_HOST_PORT:-30111}:16686"
      - "30112:14250"
      - "30113:14268"
      - "30114:4317"
      - "30117:4318"
    environment:
      # Production-like Jaeger configuration (memory storage for constrained local dev)
      COLLECTOR_OTLP_ENABLED: "true"
      SPAN_STORAGE_TYPE: "memory"
      MEMORY_MAX_TRACES: "10000"
      LOG_LEVEL: "warn"
      QUERY_MAX_CLOCK_SKEW_ADJUSTMENT: "0s"
      METRICS_BACKEND: "prometheus"
      COLLECTOR_ZIPKIN_HOST_PORT: ":9411"
    healthcheck:
      test: [ "CMD", "wget", "-qO", "/dev/null", "http://localhost:16686/" ]
      interval: 30s
      timeout: 5s
      retries: 3

  somabrain_postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-somabrain}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-somabrain}
      POSTGRES_DB: ${POSTGRES_DB:-somabrain}
      # Production-like PostgreSQL tuning for constrained environment
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "${POSTGRES_HOST_PORT:-30106}:${POSTGRES_CONTAINER_PORT:-5432}"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - somabrain_net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}" ]
      interval: 30s
      timeout: 5s
      retries: 3
    # Production-like PostgreSQL configuration
    command:
      - postgres
      - -c
      - shared_buffers=64MB
      - -c
      - effective_cache_size=128MB
      - -c
      - maintenance_work_mem=32MB
      - -c
      - work_mem=4MB
      - -c
      - max_connections=100
      - -c
      - checkpoint_completion_target=0.9
      - -c
      - wal_buffers=4MB
      - -c
      - default_statistics_target=100
      - -c
      - random_page_cost=1.1
      - -c
      - effective_io_concurrency=200
      - -c
      - min_wal_size=80MB
      - -c
      - max_wal_size=1GB
      - -c
      - log_statement=none
      - -c
      - log_duration=off
      - -c
      - log_min_duration_statement=1000
      - -c
      - autovacuum=on
      - -c
      - autovacuum_max_workers=2

  somabrain_db_migrate:
    image: somabrain:latest
    depends_on:
      somabrain_postgres:
        condition: service_healthy
    networks:
      - somabrain_net
    environment:
      # Use the internal service hostname to reach Postgres from within the network
      # Compose will substitute these from your .env
      POSTGRES_USER: "${POSTGRES_USER}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      POSTGRES_DB: "${POSTGRES_DB}"
      SOMABRAIN_POSTGRES_DSN: "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@somabrain_postgres:5432/${POSTGRES_DB}"
    # Dev convenience: run Django migrations.
    command: [ "sh", "-lc", "cd /app && python manage.py migrate --noinput" ]
    restart: "no"
    profiles: [ "dev" ]

  somabrain_postgres_exporter:
    image: prometheuscommunity/postgres-exporter:v0.15.0
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 32M
    environment:
      - DATA_SOURCE_NAME=${SOMABRAIN_POSTGRES_DSN:-postgresql://somabrain:somabrain@somabrain_postgres:5432/somabrain}?sslmode=disable
    depends_on:
      somabrain_postgres:
        condition: service_healthy
    ports:
      - "${POSTGRES_EXPORTER_HOST_PORT:-30107}:${POSTGRES_EXPORTER_CONTAINER_PORT:-9187}"
    networks:
      - somabrain_net
    healthcheck:
      test: [ "CMD", "wget", "-qO", "/dev/null", "http://localhost:9187/" ]
      interval: 30s
      timeout: 5s
      retries: 3

  somabrain_app:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    image: somabrain:latest
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    depends_on:
      somabrain_redis:
        condition: service_healthy
      somabrain_kafka:
        condition: service_healthy
      somabrain_opa:
        condition: service_healthy
      somabrain_postgres:
        condition: service_healthy
      somabrain_milvus:
        condition: service_healthy
    networks:
      - somabrain_net
    # Ensure containers can reach host services (e.g., external memory on 9595)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # Use external memory service configured via environment variables (no mock)
      SOMABRAIN_MEMORY_HTTP_ENDPOINT: "http://host.docker.internal:9595"
      SOMABRAIN_MEMORY_HTTP_TOKEN: "${SOMABRAIN_MEMORY_HTTP_TOKEN}"
      SOMABRAIN_HOST: "${SOMABRAIN_HOST:-0.0.0.0}"
      SOMABRAIN_PORT: "${SOMABRAIN_PORT:-30101}"
      SOMABRAIN_WORKERS: "${SOMABRAIN_WORKERS:-1}"
      SOMABRAIN_REDIS_URL: "${SOMABRAIN_REDIS_URL:-redis://somabrain_redis:6379/0}"
      SOMABRAIN_KAFKA_URL: "somabrain_kafka:${KAFKA_BROKER_CONTAINER_PORT:-9092}"
      SOMA_KAFKA_BOOTSTRAP: "somabrain_kafka:${KAFKA_BROKER_CONTAINER_PORT:-9092}"
      SOMABRAIN_OPA_URL: "${SOMABRAIN_OPA_URL:-http://somabrain_opa:8181}"
      SOMABRAIN_POSTGRES_DSN: "${SOMABRAIN_POSTGRES_DSN:-postgresql://somabrain:somabrain@somabrain_postgres:5432/somabrain}"
      SOMABRAIN_REQUIRE_EXTERNAL_BACKENDS: "${SOMABRAIN_REQUIRE_EXTERNAL_BACKENDS:-1}"
      SOMABRAIN_FORCE_FULL_STACK: "${SOMABRAIN_FORCE_FULL_STACK:-1}"
      SOMABRAIN_REQUIRE_MEMORY: "${SOMABRAIN_REQUIRE_MEMORY:-1}"
      SOMABRAIN_PREDICTOR_PROVIDER: "${SOMABRAIN_PREDICTOR_PROVIDER:-mahal}"
      # Memory weighting is controlled by runtime config overrides (local only)
      SOMABRAIN_DEFAULT_TENANT: "${SOMABRAIN_DEFAULT_TENANT:-sandbox}"
      # Mode: default to dev for local development parity
      SOMABRAIN_MODE: "${SOMABRAIN_MODE:-dev}"
      # Milvus configuration for vector operations
      MILVUS_HOST: "somabrain_milvus"
      MILVUS_PORT: "19530"
      SOMABRAIN_ANN_BACKEND: "${SOMABRAIN_ANN_BACKEND:-milvus}"
      SUPERVISOR_HTTP_USER: "${SUPERVISOR_HTTP_USER:-admin}"
      SUPERVISOR_HTTP_PASS: "${SUPERVISOR_HTTP_PASS:-soma}"
      # Adaptive knobs are controlled by runtime config overrides (local only)
      SOMABRAIN_LEARNING_TENANTS_FILE: "${SOMABRAIN_LEARNING_TENANTS_FILE:-/app/config/learning.tenants.yaml}"
      # Disable Kafka readiness check for local dev (tests/smoke/kafka_smoke_test.py not included)
    ports:
      - "${SOMABRAIN_HOST_PORT:-30101}:${SOMABRAIN_PORT:-30101}"
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:9696/health || exit 1" ]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 5
    # No local journal volume; fail-fast only
    # Security hardening: drop all capabilities, run with read-only rootfs, and disallow privilege escalation.
    # Note: we mount a tmpfs for /app/logs to keep runtime logs writable.
    cap_drop: [ "ALL" ]
    read_only: true
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /app/logs

  somabrain_cog:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    image: somabrain:latest
    restart: unless-stopped
    depends_on:
      somabrain_postgres:
        condition: service_healthy
      somabrain_redis:
        condition: service_healthy
      somabrain_kafka:
        condition: service_healthy
      somabrain_opa:
        condition: service_healthy
    deploy:
      resources:
        limits:
          # Production-like allocation for cognitive services
          memory: 3G
        reservations:
          memory: 2G
    networks:
      - somabrain_net
    environment:
      # Explicitly require a real external memory service; no dev fallback
      SOMABRAIN_MEMORY_HTTP_ENDPOINT: "http://host.docker.internal:9595"
      SOMABRAIN_MEMORY_HTTP_TOKEN: "${SOMABRAIN_MEMORY_HTTP_TOKEN}"
      SOMABRAIN_STRICT_REAL: "1"
      SOMABRAIN_REQUIRE_EXTERNAL_BACKENDS: "${SOMABRAIN_REQUIRE_EXTERNAL_BACKENDS:-1}"
      SOMABRAIN_REQUIRE_MEMORY: "${SOMABRAIN_REQUIRE_MEMORY:-1}"
      SOMABRAIN_MODE: "full-local"
      SOMA_HEAT_METHOD: "lanczos"
      # Centralized feature gating; composite toggles are handled via runtime config
      SOMABRAIN_REDIS_URL: "${SOMABRAIN_REDIS_URL:-redis://somabrain_redis:6379/0}"
      SOMABRAIN_KAFKA_URL: "${SOMABRAIN_KAFKA_URL}"
      SOMA_KAFKA_BOOTSTRAP: "somabrain_kafka:${KAFKA_BROKER_CONTAINER_PORT:-9092}"
      SOMABRAIN_OPA_URL: "${SOMABRAIN_OPA_URL}"
      SOMABRAIN_POSTGRES_DSN: "${SOMABRAIN_POSTGRES_DSN:-postgresql://somabrain:somabrain@somabrain_postgres:5432/somabrain}"
      # Enable OTEL tracing to Jaeger collector
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://somabrain_jaeger:4318"
      OTEL_SERVICE_NAME: "somabrain-cog"
      SOMABRAIN_DEFAULT_TENANT: "${SOMABRAIN_DEFAULT_TENANT}"
      # Supervisor HTTP auth used by API for control; only on internal network
      SUPERVISOR_HTTP_USER: "${SUPERVISOR_HTTP_USER:-admin}"
      SUPERVISOR_HTTP_PASS: "${SUPERVISOR_HTTP_PASS:-soma}"
      # Keep cognition in sync for observability (no functional dependency)
      # Adaptive knobs are controlled by runtime config overrides (local only)
      SOMABRAIN_LEARNING_TENANTS_FILE: "${SOMABRAIN_LEARNING_TENANTS_FILE:-/app/config/learning.tenants.yaml}"
      # Program-specific ports (supervisor will pass to processes)
      REWARD_PRODUCER_PORT: "${REWARD_PRODUCER_PORT:-8083}"
      SOMABRAIN_TOPIC_STATE_UPDATES: "${SOMABRAIN_TOPIC_STATE_UPDATES:-cog.state.updates}"
      SOMABRAIN_TOPIC_AGENT_UPDATES: "${SOMABRAIN_TOPIC_AGENT_UPDATES:-cog.agent.updates}"
      SOMABRAIN_TOPIC_ACTION_UPDATES: "${SOMABRAIN_TOPIC_ACTION_UPDATES:-cog.action.updates}"
      SOMABRAIN_TOPIC_GLOBAL_FRAME: "${SOMABRAIN_TOPIC_GLOBAL_FRAME:-cog.global.frame}"
      SOMABRAIN_TOPIC_NEXT_EVENT: "${SOMABRAIN_TOPIC_NEXT_EVENT:-cog.next_event}"
      SOMABRAIN_TOPIC_SEGMENTS: "${SOMABRAIN_TOPIC_SEGMENTS:-cog.segments}"
      SOMABRAIN_TOPIC_CONFIG_UPDATES: "${SOMABRAIN_TOPIC_CONFIG_UPDATES:-cog.config.updates}"
      # Milvus configuration for Oak option manager
      MILVUS_HOST: "somabrain_milvus"
      MILVUS_PORT: "19530"
    ports:
      # Reward producer HTTP (host default 30083)
      - "${COG_REWARD_PRODUCER_HOST_PORT:-30083}:8083"
      # Integrator health/metrics (program-level env set below via supervisor env)
      - "${COG_INTEGRATOR_HEALTH_HOST_PORT:-30010}:9010"
      # Segmentation health
      - "${SEGMENTATION_HEALTH_HOST_PORT:-30116}:9016"
    command: [ "/usr/bin/supervisord", "-c", "/app/ops/supervisor/supervisord.conf", "-l", "/dev/stdout" ]
    healthcheck:
      test: [ "CMD", "curl", "-fsS", "http://admin:soma@localhost:9001" ]
      interval: 30s
      timeout: 5s
      retries: 5
    cap_drop: [ "ALL" ]
    # read_only disabled to allow supervisor tmp/log paths in minimal dev
    security_opt:
      - no-new-privileges:true
    volumes:
      - type: tmpfs
        target: /app/logs
        tmpfs:
          mode: 1777
      - type: tmpfs
        target: /tmp
        tmpfs:
          mode: 1777

  somabrain_outbox_publisher:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    image: somabrain:latest
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    depends_on:
      somabrain_kafka:
        condition: service_healthy
      somabrain_postgres:
        condition: service_healthy
    networks:
      - somabrain_net
    command: [ "python", "-m", "somabrain.workers.outbox_publisher" ]
    environment:
      # Django settings MUST be first - required for all Django workers
      DJANGO_SETTINGS_MODULE: "somabrain.settings"
      SOMABRAIN_PREDICTOR_PROVIDER: "${SOMABRAIN_PREDICTOR_PROVIDER:-mahal}"
      SOMABRAIN_REQUIRE_EXTERNAL_BACKENDS: "${SOMABRAIN_REQUIRE_EXTERNAL_BACKENDS:-1}"
      SOMABRAIN_FORCE_FULL_STACK: "${SOMABRAIN_FORCE_FULL_STACK:-1}"
      SOMABRAIN_REDIS_URL: "${SOMABRAIN_REDIS_URL:-redis://somabrain_redis:6379/0}"
      SOMABRAIN_KAFKA_URL: "${SOMABRAIN_KAFKA_URL}"
      KAFKA_BOOTSTRAP_SERVERS: "somabrain_kafka:${KAFKA_BROKER_CONTAINER_PORT:-9092}"
      SOMA_KAFKA_BOOTSTRAP: "somabrain_kafka:${KAFKA_BROKER_CONTAINER_PORT:-9092}"
      SOMABRAIN_OPA_URL: "${SOMABRAIN_OPA_URL}"
      SOMABRAIN_POSTGRES_DSN: "${SOMABRAIN_POSTGRES_DSN:-postgresql://somabrain:somabrain@somabrain_postgres:5432/somabrain}"
      SOMABRAIN_OUTBOX_BATCH_SIZE: ${SOMABRAIN_OUTBOX_BATCH_SIZE:-100}
      SOMABRAIN_OUTBOX_MAX_DELAY: ${SOMABRAIN_OUTBOX_MAX_DELAY:-5.0}
      # Propagate the global memory cap to the outbox publisher.
      SOMABRAIN_MEMORY_MAX: "${SOMABRAIN_MEMORY_MAX:-10GB}"
    # No journal mount required
    cap_drop: [ "ALL" ]
    read_only: true
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /app/logs:rw,size=64m,mode=1777
      - /tmp:rw,size=64m,mode=1777
    healthcheck:
      test: [ "CMD", "true" ]
      interval: 30s
      timeout: 5s
      retries: 1

  # --- Milvus dependencies: etcd and minio -----------------------------------
  somabrain_etcd:
    image: quay.io/coreos/etcd:v3.5.5
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    environment:
      # Production-like etcd configuration (via env vars only)
      ETCD_AUTO_COMPACTION_MODE: "revision"
      ETCD_AUTO_COMPACTION_RETENTION: "1000"
      ETCD_QUOTA_BACKEND_BYTES: "4294967296"
      ETCD_SNAPSHOT_COUNT: "50000"
      ETCD_HEARTBEAT_INTERVAL: "100"
      ETCD_ELECTION_TIMEOUT: "1000"
      ETCD_MAX_SNAPSHOTS: "5"
      ETCD_MAX_WALS: "5"
      ETCD_ENABLE_V2: "false"
      ETCD_LOG_LEVEL: "warn"
      ETCD_LOGGER: "zap"
      ETCD_DATA_DIR: "/etcd"
      ETCD_LISTEN_CLIENT_URLS: "http://0.0.0.0:2379"
      ETCD_ADVERTISE_CLIENT_URLS: "http://somabrain_etcd:2379"
      ETCD_LISTEN_PEER_URLS: "http://0.0.0.0:2380"
      ETCD_INITIAL_ADVERTISE_PEER_URLS: "http://somabrain_etcd:2380"
      ETCD_INITIAL_CLUSTER: "default=http://somabrain_etcd:2380"
      ETCD_INITIAL_CLUSTER_STATE: "new"
    volumes:
      - etcd_data:/etcd
    healthcheck:
      test: [ "CMD", "etcdctl", "endpoint", "health" ]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - somabrain_net

  somabrain_minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    restart: unless-stopped
    hostname: minio
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    volumes:
      - minio_data:/minio_data
    ports:
      - "30109:9000"
      - "30110:9001"
    command: minio server /minio_data --console-address ":9001"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      somabrain_net:
        aliases:
          - minio

  # --- Milvus vector store for Oak option manager -----------------------------------
  somabrain_milvus:
    # Production-grade Milvus standalone for vector similarity search
    # Milvus standalone requires minimum 4GB RAM for all internal components
    image: milvusdb/milvus:v2.3.3
    restart: unless-stopped
    depends_on:
      somabrain_etcd:
        condition: service_healthy
      somabrain_minio:
        condition: service_healthy
    deploy:
      resources:
        limits:
          # Milvus standalone needs 4GB minimum for rootcoord, datacoord, querycoord, etc.
          memory: 4G
        reservations:
          memory: 2G
    environment:
      # Production-like Milvus configuration
      ETCD_ENDPOINTS: "somabrain_etcd:2379"
      MINIO_ADDRESS: "minio:9000"
      MINIO_ACCESS_KEY: "minioadmin"
      MINIO_SECRET_KEY: "minioadmin"
      MINIO_USE_SSL: "false"
      MINIO_BUCKET_NAME: "milvus-bucket"
      TZ: UTC
      COMMON_STORAGETYPE: "minio"
    volumes:
      - milvus_data:/var/lib/milvus
    ports:
      - "${MILVUS_GRPC_HOST_PORT:-30119}:19530"
      - "${MILVUS_HTTP_HOST_PORT:-30120}:9091"
    command: [ "milvus", "run", "standalone" ]
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9091/healthz" ]
      interval: 30s
      timeout: 20s
      retries: 10
      start_period: 180s
    networks:
      - somabrain_net

  # --- Cognitive Thread: Predictors ----------------------------------------

  # --- Cognitive Thread: Integrator + Segmentation + Orchestrator ----------

  somabrain_integrator_triplet:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    image: somabrain:latest
    restart: unless-stopped
    depends_on:
      somabrain_kafka:
        condition: service_healthy
    networks:
      - somabrain_net
    environment:
      # Django settings MUST be first - required for all Django workers
      DJANGO_SETTINGS_MODULE: "somabrain.settings"
      SOMABRAIN_KAFKA_URL: "${SOMABRAIN_KAFKA_URL}"
      KAFKA_BOOTSTRAP_SERVERS: "somabrain_kafka:${KAFKA_BROKER_CONTAINER_PORT:-9092}"
      # Propagate the global memory cap to the integrator service.
      SOMABRAIN_MEMORY_MAX: "${SOMABRAIN_MEMORY_MAX:-10GB}"
      SOMA_KAFKA_BOOTSTRAP: "somabrain_kafka:${KAFKA_BROKER_CONTAINER_PORT:-9092}"
      SOMABRAIN_TOPIC_STATE_UPDATES: "${SOMABRAIN_TOPIC_STATE_UPDATES:-cog.state.updates}"
      SOMABRAIN_TOPIC_AGENT_UPDATES: "${SOMABRAIN_TOPIC_AGENT_UPDATES:-cog.agent.updates}"
      SOMABRAIN_TOPIC_ACTION_UPDATES: "${SOMABRAIN_TOPIC_ACTION_UPDATES:-cog.action.updates}"
      SOMABRAIN_TOPIC_GLOBAL_FRAME: "${SOMABRAIN_TOPIC_GLOBAL_FRAME:-cog.global.frame}"
      SOMABRAIN_TOPIC_NEXT_EVENT: "${SOMABRAIN_TOPIC_NEXT_EVENT:-cog.next_event}"
      SOMABRAIN_TOPIC_CONFIG_UPDATES: "${SOMABRAIN_TOPIC_CONFIG_UPDATES:-cog.config.updates}"
      SOMABRAIN_STRICT_REAL: "1"
      SOMABRAIN_REQUIRE_EXTERNAL_BACKENDS: "${SOMABRAIN_REQUIRE_EXTERNAL_BACKENDS:-1}"
      SOMABRAIN_REQUIRE_MEMORY: "${SOMABRAIN_REQUIRE_MEMORY:-1}"
    command: [ "python", "-m", "somabrain.services.integrator_hub_triplet" ]
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 192M
    healthcheck:
      test: [ "CMD", "curl", "-fsS", "http://localhost:9015/health" ]
      interval: 30s
      timeout: 5s
      retries: 1
    ports:
      - "${INTEGRATOR_HEALTH_HOST_PORT:-30115}:9015"

volumes:
  kafka_data:
    driver: local
  postgres_data:
    driver: local
  redis_data:
    driver: local
  opa_data:
    driver: local
  prometheus_data:
    driver: local
  jaeger_data:
    driver: local
  etcd_data:
    driver: local
  minio_data:
    driver: local
  milvus_data:
    driver: local

networks:
  somabrain_net:
    driver: bridge
