# ═══════════════════════════════════════════════════════════════════════════════
# SomaBrain Docker Compose - EXACT MIRROR of Tilt/K8s Deployment
# ═══════════════════════════════════════════════════════════════════════════════
# Source: infra/k8s/brain-resilient.yaml + Tiltfile
# VIBE Rule 113: Port Sovereignty - 30xxx Range (Cognitive Tier L3)
# RAM BUDGET: 10GB Maximum (VIBE Rule 108)
# ═══════════════════════════════════════════════════════════════════════════════
# Usage: docker compose -f infra/docker/docker-compose.yml up -d
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ==========================================================================
  # SOMABRAIN API - Main Application
  # ==========================================================================
  # K8s Source: somabrain-api Deployment (lines 213-262)
  # Port: 20020 (NodePort)
  # Resources: 2Gi memory, 1 CPU
  # ==========================================================================
  somabrain-api:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    ports:
      - "20020:20020"
    environment:
      # From ConfigMap somabrain-config (lines 1-18)
      - SOMABRAIN_LOG_LEVEL=INFO
      - SOMABRAIN_POSTGRES_DSN=postgresql://soma:soma_pass@postgres:5432/somabrain
      - SOMABRAIN_REDIS_URL=redis://redis:6379/0
      - SOMABRAIN_REDIS_HOST=redis
      - SOMABRAIN_REDIS_PORT=6379
      - SOMABRAIN_KAFKA_URL=kafka:9092
      - SOMABRAIN_KAFKA_HOST=kafka
      - SOMABRAIN_KAFKA_PORT=9092
      - SOMABRAIN_MILVUS_HOST=milvus
      - SOMABRAIN_MILVUS_PORT=19530
      - ALLOWED_HOSTS=*
      - SOMA_API_TOKEN=dev-token-somastack2024
      - PYTHONUNBUFFERED=1
      - DJANGO_SETTINGS_MODULE=somabrain.settings
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      kafka:
        condition: service_started
      milvus:
        condition: service_started
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:20020/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ==========================================================================
  # POSTGRES - Database
  # ==========================================================================
  # K8s Source: postgres Deployment (lines 20-62)
  # Image: postgres:15-alpine
  # Port: 5432 (host: 30106 from Tiltfile)
  # Resources: 2Gi memory, 1 CPU
  # ==========================================================================
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: soma
      POSTGRES_PASSWORD: soma
      POSTGRES_DB: somabrain
    ports:
      - "30106:5432"
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U soma" ]
      interval: 5s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # REDIS - Cache
  # ==========================================================================
  # K8s Source: redis Deployment (lines 64-99)
  # Image: redis:7-alpine
  # Port: 6379 (host: 30100 from Tiltfile)
  # Resources: 1Gi memory, 0.5 CPU
  # ==========================================================================
  redis:
    image: redis:7-alpine
    ports:
      - "30100:6379"
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'

  # ==========================================================================
  # KAFKA - Message Broker (Apache Kafka 3.7.0 KRaft Mode)
  # ==========================================================================
  # K8s Source: kafka Deployment (lines 151-211)
  # Image: apache/kafka:3.7.0
  # Port: 9092 (host: 30102 from Tiltfile)
  # Resources: 2Gi memory, 1 CPU
  # ==========================================================================
  kafka:
    image: apache/kafka:3.7.0
    ports:
      - "30102:9092"
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@localhost:9093
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0
      - KAFKA_NUM_PARTITIONS=1
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'

  # ==========================================================================
  # MILVUS - Vector Database (Standalone with Embedded Etcd)
  # ==========================================================================
  # K8s Source: milvus Deployment (lines 101-149)
  # Image: milvusdb/milvus:v2.3.9
  # Port: 19530 (host: 30119 from Tiltfile)
  # Resources: 4Gi memory, 2 CPU
  # ==========================================================================
  milvus:
    image: milvusdb/milvus:v2.3.9
    command: [ "milvus", "run", "standalone" ]
    ports:
      - "30119:19530"
    environment:
      - ETCD_USE_EMBED=true
      - ETCD_DATA_DIR=/var/lib/milvus/etcd
      - COMMON_STORAGETYPE=local
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2'
