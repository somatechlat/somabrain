2025-09-25 15:12:34,911 - somabrain - INFO - ðŸ§  SomaBrain cognitive logging initialized
2025-09-25 15:12:35,565 - somabrain.cognitive - INFO - ðŸ§  Request 1758831155.56589_-5890091459584921511: POST /recall - Cognitive processing initiated
2025-09-25 15:12:35,580 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x10c56cc20>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:12:35,823 - somabrain.api.middleware.reward_gate - ERROR - RewardGateMiddleware error (failâ€‘open): [Errno 61] Connection refused
2025-09-25 15:12:35,854 - somabrain.errors - ERROR - Cognitive Error in POST /recall: {'error_type': 'ConnectError', 'error_message': '[Errno 61] Connection refused', 'context': 'POST /recall', 'timestamp': 1758831155.824626, 'request_id': '1758831155.56589_-5890091459584921511', 'traceback': 'Traceback (most recent call last):\n  File "/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py", line 101, in map_httpcore_exceptions\n    yield\n  File "/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py", line 250, in handle_request\n    resp = self._pool.handle_request(req)\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection_pool.py", line 256, in handle_request\n    raise exc from None\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection_pool.py", line 236, in handle_request\n    response = connection.handle_request(\n        pool_request.request\n    )\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection.py", line 101, in handle_request\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection.py", line 78, in handle_request\n    stream = self._connect(request)\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection.py", line 124, in _connect\n    stream = self._network_backend.connect_tcp(**kwargs)\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_backends/sync.py", line 207, in connect_tcp\n    with map_exceptions(exc_map):\n         ~~~~~~~~~~~~~~^^^^^^^^^\n  File "/usr/local/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_exceptions.py", line 14, in map_exceptions\n    raise to_exc(exc) from exc\nhttpcore.ConnectError: [Errno 61] Connection refused\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/app.py", line 417, in __call__\n    await self.app(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 182, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File "/usr/local/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 184, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/api/middleware/reward_gate.py", line 55, in dispatch\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next\n    raise app_exc\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/api/middleware/reward_gate.py", line 38, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next\n    raise app_exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 182, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File "/usr/local/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 184, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/api/middleware/opa.py", line 72, in dispatch\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next\n    raise app_exc\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/api/middleware/opa.py", line 67, in dispatch\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next\n    raise app_exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 736, in app\n    await route.handle(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle\n    await self.app(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 78, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 75, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/fastapi/routing.py", line 308, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File "/usr/local/lib/python3.13/site-packages/fastapi/routing.py", line 219, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/app.py", line 1581, in recall\n    mem_payloads, mem_hits = await _recall_ltm(\n                             ^^^^^^^^^^^^^^^^^^\n    ...<10 lines>...\n    )\n    ^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/services/recall_service.py", line 181, in recall_ltm_async\n    payloads, hits = recall_ltm(\n                     ~~~~~~~~~~^\n        mem_client,\n        ^^^^^^^^^^^\n    ...<8 lines>...\n        graph_limit,\n        ^^^^^^^^^^^^\n    )\n    ^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/services/recall_service.py", line 87, in recall_ltm\n    hits = getattr(mem_client, "recall")(text, top_k=top_k)\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/memory_client.py", line 539, in recall\n    r = self._http.post(\n        "/recall",\n        json={"query": query, "top_k": int(top_k), "universe": uni},\n        headers=rid_hdr,\n    )\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 1144, in post\n    return self.request(\n           ~~~~~~~~~~~~^\n        "POST",\n        ^^^^^^^\n    ...<11 lines>...\n        extensions=extensions,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 825, in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\n           ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 914, in send\n    response = self._send_handling_auth(\n        request,\n    ...<2 lines>...\n        history=[],\n    )\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 942, in _send_handling_auth\n    response = self._send_handling_redirects(\n        request,\n        follow_redirects=follow_redirects,\n        history=history,\n    )\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 979, in _send_handling_redirects\n    response = self._send_single_request(request)\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 1014, in _send_single_request\n    response = transport.handle_request(request)\n  File "/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py", line 249, in handle_request\n    with map_httpcore_exceptions():\n         ~~~~~~~~~~~~~~~~~~~~~~~^^\n  File "/usr/local/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py", line 118, in map_httpcore_exceptions\n    raise mapped_exc(message) from exc\nhttpx.ConnectError: [Errno 61] Connection refused\n', 'recovery_suggestions': ['Log for analysis', 'Implement graceful degradation']}
2025-09-25 15:12:35,855 - somabrain.cognitive - ERROR - ðŸ§  Request 1758831155.56589_-5890091459584921511: POST /recall - Error after 0.2587s: [Errno 61] Connection refused
2025-09-25 15:12:35,858 - httpx - INFO - HTTP Request: POST http://testserver/recall "HTTP/1.1 500 Internal Server Error"
2025-09-25 15:12:46,043 - somabrain - INFO - ðŸ§  SomaBrain cognitive logging initialized
2025-09-25 15:12:46,643 - somabrain.cognitive - INFO - ðŸ§  Request 1758831166.6437602_148469291541758899: POST /recall - Cognitive processing initiated
2025-09-25 15:12:46,671 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x1094d8c20>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:12:46,865 - somabrain.api.middleware.reward_gate - ERROR - RewardGateMiddleware error (failâ€‘open): [Errno 61] Connection refused
2025-09-25 15:12:46,966 - somabrain.errors - ERROR - Cognitive Error in POST /recall: {'error_type': 'ConnectError', 'error_message': '[Errno 61] Connection refused', 'context': 'POST /recall', 'timestamp': 1758831166.867257, 'request_id': '1758831166.6437602_148469291541758899', 'traceback': 'Traceback (most recent call last):\n  File "/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py", line 101, in map_httpcore_exceptions\n    yield\n  File "/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py", line 250, in handle_request\n    resp = self._pool.handle_request(req)\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection_pool.py", line 256, in handle_request\n    raise exc from None\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection_pool.py", line 236, in handle_request\n    response = connection.handle_request(\n        pool_request.request\n    )\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection.py", line 101, in handle_request\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection.py", line 78, in handle_request\n    stream = self._connect(request)\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection.py", line 124, in _connect\n    stream = self._network_backend.connect_tcp(**kwargs)\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_backends/sync.py", line 207, in connect_tcp\n    with map_exceptions(exc_map):\n         ~~~~~~~~~~~~~~^^^^^^^^^\n  File "/usr/local/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_exceptions.py", line 14, in map_exceptions\n    raise to_exc(exc) from exc\nhttpcore.ConnectError: [Errno 61] Connection refused\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/app.py", line 417, in __call__\n    await self.app(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 182, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File "/usr/local/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 184, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/api/middleware/reward_gate.py", line 55, in dispatch\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next\n    raise app_exc\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/api/middleware/reward_gate.py", line 38, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next\n    raise app_exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 182, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File "/usr/local/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 184, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/api/middleware/opa.py", line 72, in dispatch\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next\n    raise app_exc\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/api/middleware/opa.py", line 67, in dispatch\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next\n    raise app_exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 736, in app\n    await route.handle(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle\n    await self.app(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 78, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 75, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/fastapi/routing.py", line 308, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File "/usr/local/lib/python3.13/site-packages/fastapi/routing.py", line 219, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/app.py", line 1581, in recall\n    mem_payloads, mem_hits = await _recall_ltm(\n                             ^^^^^^^^^^^^^^^^^^\n    ...<10 lines>...\n    )\n    ^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/services/recall_service.py", line 181, in recall_ltm_async\n    payloads, hits = recall_ltm(\n                     ~~~~~~~~~~^\n        mem_client,\n        ^^^^^^^^^^^\n    ...<8 lines>...\n        graph_limit,\n        ^^^^^^^^^^^^\n    )\n    ^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/services/recall_service.py", line 87, in recall_ltm\n    hits = getattr(mem_client, "recall")(text, top_k=top_k)\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/memory_client.py", line 539, in recall\n    r = self._http.post(\n        "/recall",\n        json={"query": query, "top_k": int(top_k), "universe": uni},\n        headers=rid_hdr,\n    )\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 1144, in post\n    return self.request(\n           ~~~~~~~~~~~~^\n        "POST",\n        ^^^^^^^\n    ...<11 lines>...\n        extensions=extensions,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 825, in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\n           ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 914, in send\n    response = self._send_handling_auth(\n        request,\n    ...<2 lines>...\n        history=[],\n    )\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 942, in _send_handling_auth\n    response = self._send_handling_redirects(\n        request,\n        follow_redirects=follow_redirects,\n        history=history,\n    )\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 979, in _send_handling_redirects\n    response = self._send_single_request(request)\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 1014, in _send_single_request\n    response = transport.handle_request(request)\n  File "/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py", line 249, in handle_request\n    with map_httpcore_exceptions():\n         ~~~~~~~~~~~~~~~~~~~~~~~^^\n  File "/usr/local/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py", line 118, in map_httpcore_exceptions\n    raise mapped_exc(message) from exc\nhttpx.ConnectError: [Errno 61] Connection refused\n', 'recovery_suggestions': ['Log for analysis', 'Implement graceful degradation']}
2025-09-25 15:12:46,969 - somabrain.cognitive - ERROR - ðŸ§  Request 1758831166.6437602_148469291541758899: POST /recall - Error after 0.2234s: [Errno 61] Connection refused
2025-09-25 15:12:46,971 - httpx - INFO - HTTP Request: POST http://testserver/recall "HTTP/1.1 500 Internal Server Error"
2025-09-25 15:14:09,192 - somabrain - INFO - ðŸ§  SomaBrain cognitive logging initialized
2025-09-25 15:14:09,522 - somabrain.cognitive - INFO - ðŸ§  Request 1758831249.5221188_-290223712238377540: POST /recall - Cognitive processing initiated
2025-09-25 15:14:09,533 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x105838c20>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:14:09,655 - somabrain.cognitive - INFO - ðŸ§  Request 1758831249.5221188_-290223712238377540: POST /recall - Processing completed in 0.1330s
2025-09-25 15:14:09,655 - somabrain.cognitive - DEBUG - âœ… Request 1758831249.5221188_-290223712238377540 completed successfully
2025-09-25 15:14:09,657 - httpx - INFO - HTTP Request: POST http://testserver/recall "HTTP/1.1 200 OK"
2025-09-25 15:17:54,137 - somabrain - INFO - ðŸ§  SomaBrain cognitive logging initialized
2025-09-25 15:17:54,507 - somabrain.cognitive - INFO - ðŸ§  Request 1758831474.507075_2092660277779518908: POST /remember - Cognitive processing initiated
2025-09-25 15:17:54,518 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x10556aa50>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:17:54,623 - root - INFO - SUCCESS: Memory saved for key=topic alpha one namespace=somabrain_ns:public trace_id=4384437136
2025-09-25 15:17:54,625 - somabrain.cognitive - INFO - ðŸ§  Request 1758831474.507075_2092660277779518908: POST /remember - Processing completed in 0.1186s
2025-09-25 15:17:54,625 - somabrain.cognitive - DEBUG - âœ… Request 1758831474.507075_2092660277779518908 completed successfully
2025-09-25 15:17:54,628 - httpx - INFO - HTTP Request: POST http://testserver/remember "HTTP/1.1 200 OK"
2025-09-25 15:17:54,637 - somabrain.cognitive - INFO - ðŸ§  Request 1758831474.6378508_-3753529549973098999: POST /remember - Cognitive processing initiated
2025-09-25 15:17:54,641 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x105552210>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:17:54,649 - root - INFO - SUCCESS: Memory saved for key=topic beta two namespace=somabrain_ns:public trace_id=4386702304
2025-09-25 15:17:54,651 - somabrain.cognitive - INFO - ðŸ§  Request 1758831474.6378508_-3753529549973098999: POST /remember - Processing completed in 0.0139s
2025-09-25 15:17:54,651 - somabrain.cognitive - DEBUG - âœ… Request 1758831474.6378508_-3753529549973098999 completed successfully
2025-09-25 15:17:54,654 - httpx - INFO - HTTP Request: POST http://testserver/remember "HTTP/1.1 200 OK"
2025-09-25 15:17:54,663 - somabrain.cognitive - INFO - ðŸ§  Request 1758831474.663693_5529445455444161646: POST /remember - Cognitive processing initiated
2025-09-25 15:17:54,666 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x10576a0d0>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:17:54,675 - root - INFO - SUCCESS: Memory saved for key=topic gamma three namespace=somabrain_ns:public trace_id=4384540432
2025-09-25 15:17:54,677 - somabrain.cognitive - INFO - ðŸ§  Request 1758831474.663693_5529445455444161646: POST /remember - Processing completed in 0.0135s
2025-09-25 15:17:54,677 - somabrain.cognitive - DEBUG - âœ… Request 1758831474.663693_5529445455444161646 completed successfully
2025-09-25 15:17:54,678 - httpx - INFO - HTTP Request: POST http://testserver/remember "HTTP/1.1 200 OK"
2025-09-25 15:17:54,688 - somabrain.cognitive - INFO - ðŸ§  Request 1758831474.688277_2092660277779518908: POST /remember - Cognitive processing initiated
2025-09-25 15:17:54,691 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x10577df30>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:17:54,699 - root - INFO - SUCCESS: Memory saved for key=topic alpha two namespace=somabrain_ns:public trace_id=4386836000
2025-09-25 15:17:54,703 - somabrain.cognitive - INFO - ðŸ§  Request 1758831474.688277_2092660277779518908: POST /remember - Processing completed in 0.0147s
2025-09-25 15:17:54,703 - somabrain.cognitive - DEBUG - âœ… Request 1758831474.688277_2092660277779518908 completed successfully
2025-09-25 15:17:54,705 - httpx - INFO - HTTP Request: POST http://testserver/remember "HTTP/1.1 200 OK"
2025-09-25 15:17:54,713 - somabrain.cognitive - INFO - ðŸ§  Request 1758831474.7137449_-4705282136734275670: POST /recall - Cognitive processing initiated
2025-09-25 15:17:54,716 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x10566bce0>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:17:54,720 - somabrain.api.middleware.reward_gate - ERROR - RewardGateMiddleware error (failâ€‘open): [Errno 61] Connection refused
2025-09-25 15:17:54,737 - somabrain.errors - ERROR - Cognitive Error in POST /recall: {'error_type': 'ConnectError', 'error_message': '[Errno 61] Connection refused', 'context': 'POST /recall', 'timestamp': 1758831474.722225, 'request_id': '1758831474.7137449_-4705282136734275670', 'traceback': 'Traceback (most recent call last):\n  File "/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py", line 101, in map_httpcore_exceptions\n    yield\n  File "/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py", line 250, in handle_request\n    resp = self._pool.handle_request(req)\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection_pool.py", line 256, in handle_request\n    raise exc from None\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection_pool.py", line 236, in handle_request\n    response = connection.handle_request(\n        pool_request.request\n    )\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection.py", line 101, in handle_request\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection.py", line 78, in handle_request\n    stream = self._connect(request)\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection.py", line 124, in _connect\n    stream = self._network_backend.connect_tcp(**kwargs)\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_backends/sync.py", line 207, in connect_tcp\n    with map_exceptions(exc_map):\n         ~~~~~~~~~~~~~~^^^^^^^^^\n  File "/usr/local/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_exceptions.py", line 14, in map_exceptions\n    raise to_exc(exc) from exc\nhttpcore.ConnectError: [Errno 61] Connection refused\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/app.py", line 417, in __call__\n    await self.app(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 182, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File "/usr/local/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 184, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/api/middleware/reward_gate.py", line 55, in dispatch\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next\n    raise app_exc\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/api/middleware/reward_gate.py", line 38, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next\n    raise app_exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 182, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File "/usr/local/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 184, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/api/middleware/opa.py", line 72, in dispatch\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next\n    raise app_exc\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/api/middleware/opa.py", line 67, in dispatch\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next\n    raise app_exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 736, in app\n    await route.handle(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle\n    await self.app(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 78, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 75, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/fastapi/routing.py", line 308, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File "/usr/local/lib/python3.13/site-packages/fastapi/routing.py", line 219, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/app.py", line 1581, in recall\n    mem_payloads, mem_hits = await _recall_ltm(\n                             ^^^^^^^^^^^^^^^^^^\n    ...<10 lines>...\n    )\n    ^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/services/recall_service.py", line 181, in recall_ltm_async\n    payloads, hits = recall_ltm(\n                     ~~~~~~~~~~^\n        mem_client,\n        ^^^^^^^^^^^\n    ...<8 lines>...\n        graph_limit,\n        ^^^^^^^^^^^^\n    )\n    ^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/services/recall_service.py", line 87, in recall_ltm\n    hits = getattr(mem_client, "recall")(text, top_k=top_k)\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/memory_client.py", line 539, in recall\n    r = self._http.post(\n        "/recall",\n        json={"query": query, "top_k": int(top_k), "universe": uni},\n        headers=rid_hdr,\n    )\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 1144, in post\n    return self.request(\n           ~~~~~~~~~~~~^\n        "POST",\n        ^^^^^^^\n    ...<11 lines>...\n        extensions=extensions,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 825, in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\n           ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 914, in send\n    response = self._send_handling_auth(\n        request,\n    ...<2 lines>...\n        history=[],\n    )\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 942, in _send_handling_auth\n    response = self._send_handling_redirects(\n        request,\n        follow_redirects=follow_redirects,\n        history=history,\n    )\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 979, in _send_handling_redirects\n    response = self._send_single_request(request)\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 1014, in _send_single_request\n    response = transport.handle_request(request)\n  File "/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py", line 249, in handle_request\n    with map_httpcore_exceptions():\n         ~~~~~~~~~~~~~~~~~~~~~~~^^\n  File "/usr/local/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py", line 118, in map_httpcore_exceptions\n    raise mapped_exc(message) from exc\nhttpx.ConnectError: [Errno 61] Connection refused\n', 'recovery_suggestions': ['Log for analysis', 'Implement graceful degradation']}
2025-09-25 15:17:54,738 - somabrain.cognitive - ERROR - ðŸ§  Request 1758831474.7137449_-4705282136734275670: POST /recall - Error after 0.0084s: [Errno 61] Connection refused
2025-09-25 15:17:54,739 - httpx - INFO - HTTP Request: POST http://testserver/recall "HTTP/1.1 500 Internal Server Error"
2025-09-25 15:18:04,282 - somabrain - INFO - ðŸ§  SomaBrain cognitive logging initialized
2025-09-25 15:18:04,654 - somabrain.cognitive - INFO - ðŸ§  Request 1758831484.6547651_-8950771392525739512: POST /remember - Cognitive processing initiated
2025-09-25 15:18:04,665 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x113c92a50>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:18:04,767 - root - INFO - SUCCESS: Memory saved for key=topic alpha one namespace=somabrain_ns:public trace_id=4626838416
2025-09-25 15:18:04,769 - somabrain.cognitive - INFO - ðŸ§  Request 1758831484.6547651_-8950771392525739512: POST /remember - Processing completed in 0.1149s
2025-09-25 15:18:04,769 - somabrain.cognitive - DEBUG - âœ… Request 1758831484.6547651_-8950771392525739512 completed successfully
2025-09-25 15:18:04,772 - httpx - INFO - HTTP Request: POST http://testserver/remember "HTTP/1.1 200 OK"
2025-09-25 15:18:04,781 - somabrain.cognitive - INFO - ðŸ§  Request 1758831484.781186_-361178961514601680: POST /remember - Cognitive processing initiated
2025-09-25 15:18:04,785 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x113c7e210>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:18:04,794 - root - INFO - SUCCESS: Memory saved for key=topic beta two namespace=somabrain_ns:public trace_id=4629103584
2025-09-25 15:18:04,796 - somabrain.cognitive - INFO - ðŸ§  Request 1758831484.781186_-361178961514601680: POST /remember - Processing completed in 0.0148s
2025-09-25 15:18:04,796 - somabrain.cognitive - DEBUG - âœ… Request 1758831484.781186_-361178961514601680 completed successfully
2025-09-25 15:18:04,798 - httpx - INFO - HTTP Request: POST http://testserver/remember "HTTP/1.1 200 OK"
2025-09-25 15:18:04,809 - somabrain.cognitive - INFO - ðŸ§  Request 1758831484.809309_-1520373529844873186: POST /remember - Cognitive processing initiated
2025-09-25 15:18:04,812 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x113e960d0>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:18:04,820 - root - INFO - SUCCESS: Memory saved for key=topic gamma three namespace=somabrain_ns:public trace_id=4626941712
2025-09-25 15:18:04,822 - somabrain.cognitive - INFO - ðŸ§  Request 1758831484.809309_-1520373529844873186: POST /remember - Processing completed in 0.0130s
2025-09-25 15:18:04,822 - somabrain.cognitive - DEBUG - âœ… Request 1758831484.809309_-1520373529844873186 completed successfully
2025-09-25 15:18:04,824 - httpx - INFO - HTTP Request: POST http://testserver/remember "HTTP/1.1 200 OK"
2025-09-25 15:18:04,833 - somabrain.cognitive - INFO - ðŸ§  Request 1758831484.8332329_-8950771392525739512: POST /remember - Cognitive processing initiated
2025-09-25 15:18:04,836 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x113ea9f30>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:18:04,844 - root - INFO - SUCCESS: Memory saved for key=topic alpha two namespace=somabrain_ns:public trace_id=4629237280
2025-09-25 15:18:04,847 - somabrain.cognitive - INFO - ðŸ§  Request 1758831484.8332329_-8950771392525739512: POST /remember - Processing completed in 0.0142s
2025-09-25 15:18:04,847 - somabrain.cognitive - DEBUG - âœ… Request 1758831484.8332329_-8950771392525739512 completed successfully
2025-09-25 15:18:04,849 - httpx - INFO - HTTP Request: POST http://testserver/remember "HTTP/1.1 200 OK"
2025-09-25 15:18:04,859 - somabrain.cognitive - INFO - ðŸ§  Request 1758831484.8594089_8064416567940427399: POST /recall - Cognitive processing initiated
2025-09-25 15:18:04,862 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x113d97ce0>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:18:04,866 - somabrain.api.middleware.reward_gate - ERROR - RewardGateMiddleware error (failâ€‘open): [Errno 61] Connection refused
2025-09-25 15:18:04,882 - somabrain.errors - ERROR - Cognitive Error in POST /recall: {'error_type': 'ConnectError', 'error_message': '[Errno 61] Connection refused', 'context': 'POST /recall', 'timestamp': 1758831484.868275, 'request_id': '1758831484.8594089_8064416567940427399', 'traceback': 'Traceback (most recent call last):\n  File "/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py", line 101, in map_httpcore_exceptions\n    yield\n  File "/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py", line 250, in handle_request\n    resp = self._pool.handle_request(req)\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection_pool.py", line 256, in handle_request\n    raise exc from None\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection_pool.py", line 236, in handle_request\n    response = connection.handle_request(\n        pool_request.request\n    )\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection.py", line 101, in handle_request\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection.py", line 78, in handle_request\n    stream = self._connect(request)\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_sync/connection.py", line 124, in _connect\n    stream = self._network_backend.connect_tcp(**kwargs)\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_backends/sync.py", line 207, in connect_tcp\n    with map_exceptions(exc_map):\n         ~~~~~~~~~~~~~~^^^^^^^^^\n  File "/usr/local/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/httpcore/_exceptions.py", line 14, in map_exceptions\n    raise to_exc(exc) from exc\nhttpcore.ConnectError: [Errno 61] Connection refused\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/app.py", line 417, in __call__\n    await self.app(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 182, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File "/usr/local/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 184, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/api/middleware/reward_gate.py", line 55, in dispatch\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next\n    raise app_exc\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/api/middleware/reward_gate.py", line 38, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next\n    raise app_exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 182, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File "/usr/local/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 184, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/api/middleware/opa.py", line 72, in dispatch\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next\n    raise app_exc\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/api/middleware/opa.py", line 67, in dispatch\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next\n    raise app_exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File "/usr/local/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 736, in app\n    await route.handle(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle\n    await self.app(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 78, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File "/usr/local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app\n    raise exc\n  File "/usr/local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File "/usr/local/lib/python3.13/site-packages/starlette/routing.py", line 75, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/fastapi/routing.py", line 308, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File "/usr/local/lib/python3.13/site-packages/fastapi/routing.py", line 219, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/app.py", line 1581, in recall\n    mem_payloads, mem_hits = await _recall_ltm(\n                             ^^^^^^^^^^^^^^^^^^\n    ...<10 lines>...\n    )\n    ^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/services/recall_service.py", line 181, in recall_ltm_async\n    payloads, hits = recall_ltm(\n                     ~~~~~~~~~~^\n        mem_client,\n        ^^^^^^^^^^^\n    ...<8 lines>...\n        graph_limit,\n        ^^^^^^^^^^^^\n    )\n    ^\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/services/recall_service.py", line 87, in recall_ltm\n    hits = getattr(mem_client, "recall")(text, top_k=top_k)\n  File "/Users/macbookpro201916i964gb1tb/Documents/GitHub/somabrain/somabrain/memory_client.py", line 539, in recall\n    r = self._http.post(\n        "/recall",\n        json={"query": query, "top_k": int(top_k), "universe": uni},\n        headers=rid_hdr,\n    )\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 1144, in post\n    return self.request(\n           ~~~~~~~~~~~~^\n        "POST",\n        ^^^^^^^\n    ...<11 lines>...\n        extensions=extensions,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 825, in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\n           ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 914, in send\n    response = self._send_handling_auth(\n        request,\n    ...<2 lines>...\n        history=[],\n    )\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 942, in _send_handling_auth\n    response = self._send_handling_redirects(\n        request,\n        follow_redirects=follow_redirects,\n        history=history,\n    )\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 979, in _send_handling_redirects\n    response = self._send_single_request(request)\n  File "/usr/local/lib/python3.13/site-packages/httpx/_client.py", line 1014, in _send_single_request\n    response = transport.handle_request(request)\n  File "/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py", line 249, in handle_request\n    with map_httpcore_exceptions():\n         ~~~~~~~~~~~~~~~~~~~~~~~^^\n  File "/usr/local/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File "/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py", line 118, in map_httpcore_exceptions\n    raise mapped_exc(message) from exc\nhttpx.ConnectError: [Errno 61] Connection refused\n', 'recovery_suggestions': ['Log for analysis', 'Implement graceful degradation']}
2025-09-25 15:18:04,884 - somabrain.cognitive - ERROR - ðŸ§  Request 1758831484.8594089_8064416567940427399: POST /recall - Error after 0.0088s: [Errno 61] Connection refused
2025-09-25 15:18:04,886 - httpx - INFO - HTTP Request: POST http://testserver/recall "HTTP/1.1 500 Internal Server Error"
2025-09-25 15:18:59,380 - somabrain - INFO - ðŸ§  SomaBrain cognitive logging initialized
2025-09-25 15:18:59,754 - somabrain.cognitive - INFO - ðŸ§  Request 1758831539.7539861_5499677580028223060: POST /remember - Cognitive processing initiated
2025-09-25 15:18:59,764 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x10d59aa50>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:18:59,872 - root - INFO - SUCCESS: Memory saved for key=topic alpha one namespace=somabrain_ns:public trace_id=4518883920
2025-09-25 15:18:59,874 - somabrain.cognitive - INFO - ðŸ§  Request 1758831539.7539861_5499677580028223060: POST /remember - Processing completed in 0.1208s
2025-09-25 15:18:59,875 - somabrain.cognitive - DEBUG - âœ… Request 1758831539.7539861_5499677580028223060 completed successfully
2025-09-25 15:18:59,877 - httpx - INFO - HTTP Request: POST http://testserver/remember "HTTP/1.1 200 OK"
2025-09-25 15:18:59,888 - somabrain.cognitive - INFO - ðŸ§  Request 1758831539.888623_-5674428921286163807: POST /remember - Cognitive processing initiated
2025-09-25 15:18:59,891 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x10d58a0d0>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:18:59,904 - root - INFO - SUCCESS: Memory saved for key=topic beta two namespace=somabrain_ns:public trace_id=4521149104
2025-09-25 15:18:59,906 - somabrain.cognitive - INFO - ðŸ§  Request 1758831539.888623_-5674428921286163807: POST /remember - Processing completed in 0.0179s
2025-09-25 15:18:59,906 - somabrain.cognitive - DEBUG - âœ… Request 1758831539.888623_-5674428921286163807 completed successfully
2025-09-25 15:18:59,908 - httpx - INFO - HTTP Request: POST http://testserver/remember "HTTP/1.1 200 OK"
2025-09-25 15:18:59,920 - somabrain.cognitive - INFO - ðŸ§  Request 1758831539.920197_-2673460611403499154: POST /remember - Cognitive processing initiated
2025-09-25 15:18:59,923 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x10d58b390>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:18:59,930 - root - INFO - SUCCESS: Memory saved for key=topic gamma three namespace=somabrain_ns:public trace_id=4519052784
2025-09-25 15:18:59,932 - somabrain.cognitive - INFO - ðŸ§  Request 1758831539.920197_-2673460611403499154: POST /remember - Processing completed in 0.0126s
2025-09-25 15:18:59,933 - somabrain.cognitive - DEBUG - âœ… Request 1758831539.920197_-2673460611403499154 completed successfully
2025-09-25 15:18:59,935 - httpx - INFO - HTTP Request: POST http://testserver/remember "HTTP/1.1 200 OK"
2025-09-25 15:18:59,944 - somabrain.cognitive - INFO - ðŸ§  Request 1758831539.944434_5499677580028223060: POST /remember - Cognitive processing initiated
2025-09-25 15:18:59,947 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x10d7b4d60>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:18:59,956 - root - INFO - SUCCESS: Memory saved for key=topic alpha two namespace=somabrain_ns:public trace_id=4521283648
2025-09-25 15:18:59,958 - somabrain.cognitive - INFO - ðŸ§  Request 1758831539.944434_5499677580028223060: POST /remember - Processing completed in 0.0140s
2025-09-25 15:18:59,958 - somabrain.cognitive - DEBUG - âœ… Request 1758831539.944434_5499677580028223060 completed successfully
2025-09-25 15:18:59,960 - httpx - INFO - HTTP Request: POST http://testserver/remember "HTTP/1.1 200 OK"
2025-09-25 15:18:59,970 - somabrain.cognitive - INFO - ðŸ§  Request 1758831539.969954_2592795016556385583: POST /recall - Cognitive processing initiated
2025-09-25 15:18:59,973 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x10d6a36f0>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:18:59,981 - somabrain.cognitive - INFO - ðŸ§  Request 1758831539.969954_2592795016556385583: POST /recall - Processing completed in 0.0115s
2025-09-25 15:18:59,981 - somabrain.cognitive - DEBUG - âœ… Request 1758831539.969954_2592795016556385583 completed successfully
2025-09-25 15:18:59,983 - httpx - INFO - HTTP Request: POST http://testserver/recall "HTTP/1.1 200 OK"
2025-09-25 15:20:42,531 - somabrain - INFO - ðŸ§  SomaBrain cognitive logging initialized
2025-09-25 15:20:42,703 - somabrain - WARNING - ConstitutionEngine load failed: Constitution key 'soma:constitution' not found in Redis
2025-09-25 15:21:07,200 - somabrain.cognitive - INFO - ðŸ§  Request 1758831667.200248_4147715638985798258: GET /constitution/version - Cognitive processing initiated
2025-09-25 15:21:07,212 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x1099927b0>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:21:07,215 - somabrain.cognitive - INFO - ðŸ§  Request 1758831667.200248_4147715638985798258: GET /constitution/version - Processing completed in 0.0151s
2025-09-25 15:21:07,215 - somabrain.cognitive - DEBUG - âœ… Request 1758831667.200248_4147715638985798258 completed successfully
2025-09-25 15:21:07,226 - somabrain.cognitive - INFO - ðŸ§  Request 1758831667.2267962_4801792349479309501: POST /constitution/validate - Cognitive processing initiated
2025-09-25 15:21:07,229 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x1099ab250>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:21:07,277 - somabrain.cognitive - INFO - ðŸ§  Request 1758831667.2267962_4801792349479309501: POST /constitution/validate - Processing completed in 0.0503s
2025-09-25 15:21:07,277 - somabrain.cognitive - DEBUG - âœ… Request 1758831667.2267962_4801792349479309501 completed successfully
2025-09-25 15:22:15,903 - somabrain.cognitive - INFO - ðŸ§  Request 1758831735.903853_1187695411812921274: GET /constitution/version - Cognitive processing initiated
2025-09-25 15:22:15,907 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x10996bd90>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:22:15,910 - somabrain.cognitive - INFO - ðŸ§  Request 1758831735.903853_1187695411812921274: GET /constitution/version - Processing completed in 0.0061s
2025-09-25 15:22:15,910 - somabrain.cognitive - DEBUG - âœ… Request 1758831735.903853_1187695411812921274 completed successfully
2025-09-25 15:22:15,921 - somabrain.cognitive - INFO - ðŸ§  Request 1758831735.921677_-8003811922344403771: POST /constitution/validate - Cognitive processing initiated
2025-09-25 15:22:15,925 - somabrain.opa - WARNING - OPA evaluation failed (fallback allow): HTTPConnectionPool(host='localhost', port=8181): Max retries exceeded with url: /v1/data/somabrain/auth/allow (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x109e24fc0>: Failed to establish a new connection: [Errno 61] Connection refused'))
2025-09-25 15:22:15,940 - somabrain.cognitive - INFO - ðŸ§  Request 1758831735.921677_-8003811922344403771: POST /constitution/validate - Processing completed in 0.0187s
2025-09-25 15:22:15,940 - somabrain.cognitive - DEBUG - âœ… Request 1758831735.921677_-8003811922344403771 completed successfully
