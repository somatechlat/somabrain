# SomaBrain Environment Template
#
# Copy this file to `.env` (or export the variables manually) to run the
# stack locally. Values are safe defaults for development; override them per
# environment as needed.

## Core infrastructure --------------------------------------------------------
SOMABRAIN_POSTGRES_DSN=postgresql://somabrain:somabrain@127.0.0.1:5432/somabrain
SOMABRAIN_REDIS_URL=redis://127.0.0.1:6379/0
SOMABRAIN_KAFKA_URL=127.0.0.1:30102
# In-container bootstrap for services (compose/k8s will typically set this)
SOMA_KAFKA_BOOTSTRAP=somabrain_kafka:9092
SOMABRAIN_MEMORY_HTTP_ENDPOINT=http://127.0.0.1:9595
SOMABRAIN_MEMORY_HTTP_TOKEN=
SOMABRAIN_HTTP_MAX_CONNS=64
SOMABRAIN_HTTP_KEEPALIVE=32
SOMABRAIN_HTTP_RETRIES=1

## Authentication -------------------------------------------------------------
SOMABRAIN_JWT_SECRET=
SOMABRAIN_JWT_PUBLIC_KEY_PATH=

## Enforcement & feature flags -----------------------------------------------
SOMABRAIN_REQUIRE_EXTERNAL_BACKENDS=1
SOMABRAIN_FORCE_FULL_STACK=1
SOMABRAIN_REQUIRE_MEMORY=1
SOMABRAIN_MINIMAL_PUBLIC_API=0
SOMABRAIN_PREDICTOR_PROVIDER=mahal
SOMABRAIN_MODE=full-local

# Best-mode defaults (production-grade)
# Enforce strict-real behavior and use the Lanczos heat diffusion method.
SOMABRAIN_STRICT_REAL=1
SOMA_HEAT_METHOD=lanczos
# Enable teach feedback processor loop (maps feedback to r_user rewards)
SOMABRAIN_ENABLE_TEACH_FEEDBACK=1
SOMABRAIN_FF_REWARD_INGEST=1
SOMABRAIN_FF_LEARNER_ONLINE=1
SOMABRAIN_FF_NEXT_EVENT=1
SOMABRAIN_FF_CONFIG_UPDATES=1

## Integrator normalization (confidence from delta_error)
# Default ON for cross-domain consistency; set to 0 to disable explicitly
SOMABRAIN_INTEGRATOR_ENFORCE_CONF=1
# Confidence mapping alpha (c = exp(-alpha * delta_error))
SOMABRAIN_INTEGRATOR_ALPHA=2.0

## Memory client configuration -----------------------------------------------
SOMABRAIN_MEMORY_ENABLE_WEIGHTING=0
SOMABRAIN_MEMORY_PHASE_PRIORS=
SOMABRAIN_MEMORY_QUALITY_EXP=1.0
SOMABRAIN_MEMORY_FAST_ACK=0
MEMORY_DB_PATH=./data/memory.db

## OPA -----------------------------------------------------------------------
SOMABRAIN_OPA_URL=http://127.0.0.1:8181
SOMA_OPA_TIMEOUT=2.0
# OPA posture derived from mode; fail-closed enforced (flag removed)

## Miscellaneous --------------------------------------------------------------
SOMABRAIN_LEARNING_LOOP_ENABLED=0
SOMABRAIN_LEARNING_RATE_DYNAMIC=0
SOMABRAIN_DEBUG_MEMORY_CLIENT=0
SOMABRAIN_DEFAULT_TENANT=sandbox
## Learning loop (adaptive) -------------------------------------------------
# Topic names (override only if deploying multiple isolated pipelines)
SOMABRAIN_TOPIC_REWARD_EVENTS=cog.reward.events
SOMABRAIN_TOPIC_CONFIG_UPDATES=cog.config.updates
SOMABRAIN_TOPIC_GLOBAL_FRAME=cog.global.frame
SOMABRAIN_TOPIC_NEXT_EVENT=cog.next_event
SOMABRAIN_TOPIC_NEXT_EVENTS=cog.next_event  # legacy alias
SOMABRAIN_TOPIC_STATE_UPDATES=cog.state.updates
SOMABRAIN_TOPIC_AGENT_UPDATES=cog.agent.updates
SOMABRAIN_TOPIC_ACTION_UPDATES=cog.action.updates

# Learner parameters
LEARNER_EMA_ALPHA=0.2
LEARNER_EMIT_PERIOD=30
LEARNER_TAU_MIN=0.1
LEARNER_TAU_MAX=1.0
LEARNER_DEFAULT_LR=0.05
LEARNER_KEEPALIVE_TAU=0.7
# Force JSON serialization for config updates (debug only)
LEARNER_FORCE_JSON=0

# Reward producer overrides
REWARD_PRODUCER_PORT=8083
REWARD_FORCE_JSON=1


# Optional overrides for scripting or helper tools
SOMABRAIN_AUTH_SERVICE_URL=
SOMABRAIN_AUTH_SERVICE_API_KEY=
SOMABRAIN_TENANT=

## Database migrations (developer convenience) -----------------------------
# When set to 1, the API entrypoint will attempt to run Alembic migrations on startup.
# Recommended: keep OFF by default; enable for local dev only.
# Production/staging should run migrations as a one-shot task instead (see scripts/migrate_db.sh).
SOMABRAIN_AUTO_MIGRATE=0

## Kafka dual-listener (optional dev overrides) -----------------------------
# Host port mapped to EXTERNAL listener in docker-compose
KAFKA_BROKER_HOST_PORT=30102
# EXTERNAL listener container port (INTERNAL stays on 9092)
KAFKA_BROKER_EXTERNAL_CONTAINER_PORT=9094
KAFKA_CFG_NODE_ID=1
KAFKA_CFG_PROCESS_ROLES=broker,controller
KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@somabrain_kafka:9093
KAFKA_CFG_LISTENERS=INTERNAL://0.0.0.0:9092,EXTERNAL://0.0.0.0:9094,CONTROLLER://0.0.0.0:9093
KAFKA_CFG_ADVERTISED_LISTENERS=INTERNAL://somabrain_kafka:9092,EXTERNAL://localhost:${KAFKA_BROKER_HOST_PORT}
KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
KAFKA_CFG_INTER_BROKER_LISTENER_NAME=INTERNAL
KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
KAFKA_CFG_NUM_PARTITIONS=2
KAFKA_CFG_DEFAULT_REPLICATION_FACTOR=1
KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR=1
KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR=1
KAFKA_CFG_LOG_DIRS=/var/lib/kafka/data
KAFKA_CFG_LOG_RETENTION_MS=604800000
KAFKA_CFG_LOG_SEGMENT_BYTES=52428800
KAFKA_CFG_LOG_RETENTION_BYTES=536870912
KAFKA_CFG_COMPRESSION_TYPE=snappy
KAFKA_HEAP_OPTS=-Xmx384m -Xms256m
KAFKA_CLUSTER_ID=79LccNO-Qe6G6YgqP1Zrew

## Local Journal -------------------------------------------------------------
# Local file-based journaling for reliable event storage
# Journal provides redundant persistence for all events
SOMABRAIN_JOURNAL_DIR=/tmp/somabrain_journal
SOMABRAIN_JOURNAL_MAX_FILE_SIZE=104857600  # 100MB
SOMABRAIN_JOURNAL_MAX_FILES=10
SOMABRAIN_JOURNAL_ROTATION_INTERVAL=86400  # 24 hours
SOMABRAIN_JOURNAL_RETENTION_DAYS=7
SOMABRAIN_JOURNAL_COMPRESSION=true
SOMABRAIN_JOURNAL_SYNC_WRITES=true
SOMABRAIN_JOURNAL_REPLAY_INTERVAL=300  # 5 seconds

# Core ports (prod-like local)
REDIS_HOST_PORT=30100
REDIS_CONTAINER_PORT=6379
KAFKA_EXPORTER_HOST_PORT=30103
KAFKA_EXPORTER_CONTAINER_PORT=9308
OPA_HOST_PORT=30104
OPA_CONTAINER_PORT=8181
PROMETHEUS_HOST_PORT=30105
PROMETHEUS_CONTAINER_PORT=9090
POSTGRES_HOST_PORT=30106
POSTGRES_CONTAINER_PORT=5432
POSTGRES_EXPORTER_HOST_PORT=30107
POSTGRES_EXPORTER_CONTAINER_PORT=9187
SOMABRAIN_HOST_PORT=9696
SOMABRAIN_PORT=9696
# Health/metrics ports
COG_INTEGRATOR_HEALTH_HOST_PORT=30010   # supervisor health/metrics inside cog container
SEGMENTATION_HEALTH_HOST_PORT=30116     # segmentation_service health (9016)
INTEGRATOR_HEALTH_HOST_PORT=30115       # integrator_hub_triplet health (9015)

## OpenTelemetry (mandatory tracing) ---------------------------------------
OTEL_EXPORTER_OTLP_ENDPOINT=http://127.0.0.1:4318
OTEL_SERVICE_NAME=somabrain-api
OTEL_TRACES_EXPORTER=otlp
# Metrics/logs exporters intentionally disabled (prometheus + structured logs used)
OTEL_METRICS_EXPORTER=none
OTEL_LOGS_EXPORTER=none
