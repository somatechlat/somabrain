# Minimal Kubernetes manifests for Somabrain dev (namespace: somabrain-dev)
# NOTE: Adjust image names to match your local registry or build and load into kind.

---
apiVersion: v1
kind: Namespace
metadata:
  name: somabrain-dev

---
apiVersion: v1
kind: Service
metadata:
  name: somabrain
  namespace: somabrain-dev
spec:
  type: NodePort  # change to LoadBalancer in minikube/metalLB if preferred
  ports:
    - port: 9696
      targetPort: 9696
      protocol: TCP
      nodePort: 30096
  selector:
    app: somabrain

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: somabrain
  namespace: somabrain-dev
spec:
  replicas: 1
  selector:
    matchLabels:
      app: somabrain
  template:
    metadata:
      labels:
        app: somabrain
    spec:
      containers:
        - name: somabrain
          image: somatechlat/somabrain:dev
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 9696
          volumeMounts:
            - name: brain-artifacts
              mountPath: /var/lib/somabrain
          env:
            # Core connectivity
            - name: SOMA_KAFKA_URL
              value: "sb-kafka:9092"
            - name: SOMABRAIN_OPA_URL
              value: "http://sb-opa:8181"
            - name: SOMA_REDIS_URL
              value: "redis://sb-redis:6379/0"
            - name: SOMABRAIN_MEMORY_HTTP_ENDPOINT
              value: "http://somamemory:9595"
            # Strict + full-stack + best profile (no mocks)
            - name: SOMABRAIN_STRICT_REAL
              value: "1"
            - name: SOMABRAIN_FORCE_FULL_STACK
              value: "1"
            - name: SOMABRAIN_REQUIRE_MEMORY
              value: "1"
            - name: SOMABRAIN_ENABLE_BEST
              value: "1"
            # Predictor provider
            - name: SOMABRAIN_PREDICTOR_PROVIDER
              value: "mahal"
            # Memory weighting & priors
            - name: SOMABRAIN_MEMORY_ENABLE_WEIGHTING
              value: "1"
            - name: SOMABRAIN_MEMORY_PHASE_PRIORS
              value: "bootstrap:1.05,general:1.0,specialized:1.03"
            - name: SOMABRAIN_MEMORY_QUALITY_EXP
              value: "1.0"
            # HTTP client tuning (adjusted for prod-like dev)
            - name: SOMABRAIN_HTTP_MAX_CONNS
              value: "32"
            - name: SOMABRAIN_HTTP_KEEPALIVE
              value: "16"
            - name: SOMABRAIN_HTTP_RETRIES
              value: "1"
            # Default tenant
            - name: SOMABRAIN_DEFAULT_TENANT
              value: "sandbox"
          resources:
            requests:
              cpu: "250m"
              memory: "512Mi"
            limits:
              cpu: "1"
              memory: "1Gi"
          readinessProbe:
            httpGet:
              path: /health
              port: 9696
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              port: 9696
            initialDelaySeconds: 15
            periodSeconds: 20
      volumes:
        - name: brain-artifacts
          persistentVolumeClaim:
            claimName: brain-artifacts-pvc

---
# Redis - simple deployment for dev. For production use a StatefulSet and PVCs.
apiVersion: v1
kind: Service
metadata:
  name: sb-redis
  namespace: somabrain-dev
spec:
  ports:
    - port: 6379
      targetPort: 6379
  selector:
    app: sb-redis
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sb-redis
  namespace: somabrain-dev
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sb-redis
  template:
    metadata:
      labels:
        app: sb-redis
    spec:
      containers:
        - name: redis
          image: redis:7.2
          ports:
            - containerPort: 6379
          volumeMounts:
            - name: redis-data
              mountPath: /data
          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
            limits:
              cpu: "200m"
              memory: "256Mi"
      volumes:
        - name: redis-data
          persistentVolumeClaim:
            claimName: redis-data-pvc

---
# OPA
apiVersion: v1
kind: Service
metadata:
  name: sb-opa
  namespace: somabrain-dev
spec:
  ports:
    - port: 8181
      targetPort: 8181
  selector:
    app: sb-opa
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sb-opa
  namespace: somabrain-dev
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sb-opa
  template:
    metadata:
      labels:
        app: sb-opa
    spec:
      containers:
        - name: opa
          image: openpolicyagent/opa:0.54.0
          args: ["run", "--server", "--addr=0.0.0.0:8181"]
          ports:
            - containerPort: 8181
          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
            limits:
              cpu: "200m"
              memory: "128Mi"

---
# Memory service (SFM) placeholder - replace image with your memory service image
apiVersion: v1
kind: Service
metadata:
  name: somamemory
  namespace: somabrain-dev
spec:
  ports:
    - port: 9595
      targetPort: 9595
  selector:
    app: somamemory
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: somamemory
  namespace: somabrain-dev
spec:
  replicas: 1
  selector:
    matchLabels:
      app: somamemory
  template:
    metadata:
      labels:
        app: somamemory
    spec:
      containers:
        - name: somamemory
          image: somatechlat/somamemory:dev
          ports:
            - containerPort: 9595
          volumeMounts:
            - name: memory-data
              mountPath: /data
          readinessProbe:
            httpGet:
              path: /health
              port: 9595
            initialDelaySeconds: 3
            periodSeconds: 5
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "800m"
              memory: "512Mi"

      volumes:
        - name: brain-artifacts
          persistentVolumeClaim:
            claimName: brain-artifacts-pvc
        - name: redis-data
          persistentVolumeClaim:
            claimName: redis-data-pvc
        - name: memory-data
          persistentVolumeClaim:
            claimName: somamemory-data-pvc

---
# Persistent Volume Claims (adjust storageClassName as needed for your cluster)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: brain-artifacts-pvc
  namespace: somabrain-dev
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-data-pvc
  namespace: somabrain-dev
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 512Mi

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: somamemory-data-pvc
  namespace: somabrain-dev
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi

# NOTES:
# - For Kafka, Postgres and Qdrant, prefer using an operator/helm chart. See docs/KUBERNETES_MIGRATION.md for recommendations.
# - Update image names to match your builds and registry. For kind, use `kind load docker-image`.
# - NodePort 30096 exposes Somabrain on cluster node(s). For local dev with kind/minikube you can use this or run `kubectl port-forward`.
